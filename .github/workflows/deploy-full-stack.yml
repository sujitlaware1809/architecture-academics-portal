name: Deploy Full Stack to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - frontend
        - backend

env:
  EC2_HOST: 15.206.47.135
  FRONTEND_PORT: 3000
  BACKEND_PORT: 8000

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Set deployment target
          DEPLOY_TARGET="${{ github.event.inputs.deploy_target || 'both' }}"
          
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“ Target: $DEPLOY_TARGET"
          
          # Navigate to project directory
          cd /home/ec2-user/architecture-academics-portal
          
          # Create database backup before deployment
          echo "ğŸ’¾ Creating database backup..."
          chmod +x deployment/backup-database.sh
          ./deployment/backup-database.sh || echo "âš ï¸ Backup failed or no database found"
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Deploy Backend
          if [ "$DEPLOY_TARGET" = "both" ] || [ "$DEPLOY_TARGET" = "backend" ]; then
            echo "ğŸ Deploying backend..."
            
            # Stop backend service
            sudo systemctl stop backend || true
            
            cd backend
            
            # Activate virtual environment and install dependencies
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Skip database migrations to preserve existing data
            # python migrate_db.py || echo "âš ï¸ Migration skipped to preserve existing data"
            echo "â„¹ï¸  Preserving existing database - no migrations will run"
            
            cd ..
            
            # Start backend service
            sudo systemctl start backend
            sudo systemctl enable backend
            
            # Check backend status
            sleep 5
            if sudo systemctl is-active --quiet backend; then
              echo "âœ… Backend deployed successfully!"
            else
              echo "âŒ Backend deployment failed!"
              sudo journalctl -u backend --no-pager -n 20
            fi
          fi
          
          # Deploy Frontend
          if [ "$DEPLOY_TARGET" = "both" ] || [ "$DEPLOY_TARGET" = "frontend" ]; then
            echo "âš›ï¸ Deploying frontend..."
            
            # Stop frontend service
            sudo systemctl stop frontend || true
            
            cd frontend
            
            # Update environment variables
            echo "NEXT_PUBLIC_API_URL=http://${{ env.EC2_HOST }}:${{ env.BACKEND_PORT }}" > .env.local
            echo "NEXT_PUBLIC_SITE_URL=http://${{ env.EC2_HOST }}:${{ env.FRONTEND_PORT }}" >> .env.local
            
            # Install dependencies and build
            npm ci --production=false
            npm run build
            
            cd ..
            
            # Start frontend service
            sudo systemctl start frontend
            sudo systemctl enable frontend
            
            # Check frontend status
            sleep 5
            if sudo systemctl is-active --quiet frontend; then
              echo "âœ… Frontend deployed successfully!"
            else
              echo "âŒ Frontend deployment failed!"
              sudo journalctl -u frontend --no-pager -n 20
            fi
          fi
          
          echo ""
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸŒ Application URLs:"
          echo "   Frontend: http://${{ env.EC2_HOST }}:${{ env.FRONTEND_PORT }}"
          echo "   Backend API: http://${{ env.EC2_HOST }}:${{ env.BACKEND_PORT }}"
          
          # Show service status
          echo ""
          echo "ğŸ“Š Service Status:"
          sudo systemctl status backend --no-pager -l || true
          sudo systemctl status frontend --no-pager -l || true

    - name: Health Check
      if: success()
      run: |
        echo "ğŸ¥ Performing health checks..."
        
        # Check backend health
        echo "Checking backend..."
        curl -f http://15.206.47.135:8000/health || echo "âš ï¸ Backend health check failed"
        
        # Check frontend
        echo "Checking frontend..."
        curl -f http://15.206.47.135:3000 || echo "âš ï¸ Frontend health check failed"
        
        echo "âœ… Health checks completed"

    - name: Notify Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Your application is live at http://15.206.47.135:3000"
        else
          echo "âŒ Deployment failed!"
          echo "Please check the logs for more information."
        fi